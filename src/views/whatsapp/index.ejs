<section class="content mt-2">
  <div class="container-fluid">
    <div class="row">
        <div class="col-md-4 col-sm-12 mb-2">
        <div class="card shadow">
        <!-- HEADER -->
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <h3 class="card-title mb-0">
            <i class="bi bi-robot"></i> Manajement WhatsApp
            </h3>
            <span id="wa-status-badge" class="badge bg-secondary">
            Checking...
            </span>
        </div>

        <!-- BODY -->
        <div class="card-body">

            <!-- LOADING -->
            <div id="wa-loading" class="text-center">
            <div class="spinner-border text-dark"></div>
            <p class="mt-2">Menyiapkan WhatsApp...</p>
            </div>

            <!-- CONNECTED -->
            <div id="wa-connected" class="d-none">

            <!-- INFO -->
            <div class="alert alert-success mb-3">
                <h5 class="mb-1">âœ… WhatsApp Terhubung</h5>
                <small id="wa-info"></small>
            </div>

            <!-- SEND MESSAGE -->
            <div id="wa-send-box" class="mt-3 d-none">
                <h6>Kirim Pesan</h6>

                <div class="mb-2">
                <input
                    type="text"
                    id="wa-phone"
                    class="form-control"
                    placeholder="Contoh: 6281234567890"
                />
                </div>

                <div class="mb-2">
                <textarea
                    id="wa-message"
                    class="form-control"
                    rows="3"
                    placeholder="Tulis pesan..."
                ></textarea>
                </div>

                <button id="btn-send" class="btn btn-primary btn-sm">
                <i class="bi bi-send"></i> Kirim
                </button>

                <div id="send-status" class="mt-2 small"></div>
            </div>

            <!-- LOGOUT -->
            <div class="mt-4">
                <button id="btn-logout" class="btn btn-danger btn-sm">
                <i class="bi bi-box-arrow-right"></i> Logout WhatsApp
                </button>
            </div>
            </div>

            <!-- QR -->
            <div id="wa-qr" class="text-center d-none">
            <p class="mb-2">Scan QR Code berikut menggunakan WhatsApp</p>
            <img id="qr-image" class="img-fluid" style="max-width:280px;" />
            <p class="text-muted mt-2">QR akan berubah otomatis</p>
            </div>

            <!-- CONNECT -->
            <div id="wa-disconnected" class="text-center d-none">
              <button id="btn-connect" class="btn btn-success btn-sm">
                <i class="bi bi-plug"></i> Connect WhatsApp
              </button>
            </div>


        </div>
        </div>
    </div>
    <div class="col-md-8 col-sm-12 mb-2">
        <div class="card shadow">
        <!-- HEADER -->
        <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
            <h3 class="card-title mb-0">
            <i class="bi bi-info-circle"></i> Log Whatsapp
            </h3>
        </div>
            <div class="card-body">
                ðŸ“© PESAN MASUK <br>
                Dari : 74530684965000@lid <br>
                Nama : Ù…Ù†Ø¬ÙŠ Ø³ØªÙŠØ§Ø¡ÙˆØ§Ù† <br>
                Isi  : halo <br> <hr>
                ðŸ“© PESAN MASUK <br>
                Dari : 74530684965000@lid <br>
                Nama : Ù…Ù†Ø¬ÙŠ Ø³ØªÙŠØ§Ø¡ÙˆØ§Ù† <br>
                Isi  : Ping
            </div>
        </div>
    </div>
    </div>
  </div>
</section>

<script>
  const statusBadge = document.getElementById("wa-status-badge");
  const connectedBox = document.getElementById("wa-connected");
  const qrBox = document.getElementById("wa-qr");
  const loadingBox = document.getElementById("wa-loading");
  const qrImage = document.getElementById("qr-image");
  const waInfo = document.getElementById("wa-info");
  const sendBox = document.getElementById("wa-send-box");

  const btnSend = document.getElementById("btn-send");
  const sendStatus = document.getElementById("send-status");

  const btnConnect = document.getElementById("btn-connect");
  const disconnectedBox = document.getElementById("wa-disconnected");
  const btnLogout = document.getElementById("btn-logout");

  let interval = null;

  // ===== Reset semua UI
  function resetUI() {
    connectedBox.classList.add("d-none");
    qrBox.classList.add("d-none");
    disconnectedBox.classList.add("d-none");
    sendBox.classList.add("d-none");
    loadingBox.classList.remove("d-none");
    waInfo.innerText = "";
  }

  // ===== Render connected state
  function renderConnected(info) {
    resetUI();
    statusBadge.className = "badge bg-success";
    statusBadge.innerText = "CONNECTED";

    connectedBox.classList.remove("d-none");
    sendBox.classList.remove("d-none");
    loadingBox.classList.add("d-none");

    if (info) {
      waInfo.innerText =
        `ðŸ‘¤ ${info.name || "-"} | ðŸ“± ${info.jid || "-"} | ðŸ’» ${info.platform || "-"}`;
    }
  }

// ===== Render disconnected / QR state
function renderDisconnected(hasQR, qr, hasSession) {
  resetUI();

  // Badge: kalau QR ready tampil "SCAN QR", kalau ada session tapi belum connect tampil "CONNECT", kalau tidak ada apa-apa tampil "DISCONNECTED"
  if (hasQR) {
    statusBadge.className = "badge bg-warning text-dark";
    statusBadge.innerText = "SCAN QR";
  } else if (hasSession) {
    statusBadge.className = "badge bg-info text-dark";
    statusBadge.innerText = "CONNECT";
  } else {
    statusBadge.className = "badge bg-warning text-dark";
    statusBadge.innerText = "DISCONNECTED";
  }

  disconnectedBox.classList.remove("d-none");

  // Loading: tampil kalau belum ada status pasti
  if (hasQR || hasSession) {
    loadingBox.classList.remove("d-none"); // masih menunggu QR scan / connect
  } else {
    loadingBox.classList.add("d-none"); // status sudah pasti: tidak ada session, tidak ada QR
  }

  // QR Box
  if (hasQR && qr) {
    qrBox.classList.remove("d-none");
    qrImage.src =
      "https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=" +
      encodeURIComponent(qr);
  }
}


  // ===== Ambil status WA dari backend
async function fetchStatus() {
  try {
    const res = await fetch("/whatsapp/status");
    const data = await res.json();

    // sembunyikan loading jika status sudah pasti
    if (data.connected || data.qr || data.hasSession) {
      loadingBox.classList.add("d-none");
    } else {
      loadingBox.classList.remove("d-none");
    }

    if (data.connected) {
      renderConnected(data.info);
    } else {
      // panggil renderDisconnected dengan hasSession
      renderDisconnected(!!data.qr, data.qr, !!data.hasSession);
    }
  } catch (err) {
    statusBadge.className = "badge bg-danger";
    statusBadge.innerText = "ERROR";
    console.error(err);
  }
}


  // ===== INIT =====
  fetchStatus();
  interval = setInterval(fetchStatus, 3000);

  // ===== CONNECT =====
  btnConnect.addEventListener("click", async () => {
    btnConnect.disabled = true;
    btnConnect.innerText = "Connecting...";

    try {
      await fetch("/whatsapp/init", { method: "POST" });
      await fetchStatus(); // update UI setelah connect
    } catch (err) {
      console.error(err);
    } finally {
      btnConnect.disabled = false;
      btnConnect.innerText = "Connect WhatsApp";
    }
  });

  // ===== SEND MESSAGE =====
  btnSend.addEventListener("click", async () => {
    const phone = document.getElementById("wa-phone").value.trim();
    const message = document.getElementById("wa-message").value.trim();

    if (!phone || !message) {
      sendStatus.innerText = "Nomor & pesan wajib diisi";
      sendStatus.className = "text-danger";
      return;
    }

    btnSend.disabled = true;
    sendStatus.innerText = "Mengirim...";
    sendStatus.className = "text-muted";

    try {
      const res = await fetch("/whatsapp/send", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ phone, message })
      });

      const data = await res.json();

      if (data.success) {
        sendStatus.innerText = "âœ… Pesan terkirim";
        sendStatus.className = "text-success";
        document.getElementById("wa-message").value = "";
      } else {
        sendStatus.innerText = data.message || "Gagal mengirim";
        sendStatus.className = "text-danger";
      }
    } catch (err) {
      sendStatus.innerText = "Error kirim pesan";
      sendStatus.className = "text-danger";
    } finally {
      btnSend.disabled = false;
    }
  });

  // ===== LOGOUT =====
  btnLogout.addEventListener("click", async () => {
    if (!confirm("Yakin disconnect WhatsApp?")) return;

    btnLogout.disabled = true;
    btnLogout.innerText = "Logging out...";

    try {
      const res = await fetch("/whatsapp/logout", { method: "POST" });
      const data = await res.json();

      if (data.success) {
        // UI reset
        resetUI();
        statusBadge.className = "badge bg-warning text-dark";
        statusBadge.innerText = "DISCONNECTED";
        disconnectedBox.classList.remove("d-none");
      } else {
        alert("Gagal logout: " + data.message);
      }
    } catch (err) {
      console.error(err);
      alert("Error saat logout");
    } finally {
      btnLogout.disabled = false;
      btnLogout.innerText = "Logout WhatsApp";
    }
  });

</script>

