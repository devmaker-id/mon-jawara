<section class="content mt-3">
  <div class="container-fluid">

    <% if (flashData) { %>
      <div class="alert alert-<%= flashData.type %> alert-dismissible fade show" role="alert">
        <%= flashData.text %>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    <% } %>

    <div class="card shadow-sm">
      <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-person-check-fill me-2"></i> Data Limit Akun VPN</h5>
      </div>

      <div class="card-body">
        <div class="">
          <table id="limitTable" class="table table-bordered table-hover table-striped text-nowrap align-middle w-100">
            <thead class="table-primary text-center">
              <tr>
                <th>ID</th>
                <th>User ID</th>
                <th>Username</th>
                <th>Limit</th>
                <th>Used</th>
                <th>Dibuat</th>
                <th>Diupdate</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody>
              <% if (limits && limits.length > 0) { %>
                <% limits.forEach(item => { %>
                  <tr id="row-<%= item.id %>">
                    <td><%= item.id %></td>
                    <td><%= item.user_id %></td>
                    <td><%= item.username %></td>
                    <td id="limit-value-<%= item.id %>"><%= item.limit %></td>
                    <td><%= item.used %></td>
                    <td><%= new Date(item.created_at).toLocaleString('id-ID') %></td>
                    <td id="updated-at-<%= item.id %>"><%= new Date(item.updated_at).toLocaleString('id-ID') %></td>
                    <td class="text-center">
                      <button class="btn btn-sm btn-warning btn-edit"
                        data-id="<%= item.id %>"
                        data-user="<%= item.username %>"
                        data-limit="<%= item.limit %>"
                        data-used="<%= item.used %>">
                        <i class="bi bi-pencil"></i> Edit
                      </button>
                    </td>
                  </tr>
                <% }) %>
              <% } else { %>
                <tr>
                  <td colspan="8" class="text-center">Tidak ada data tersedia</td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</section>

<!-- Modal Edit Limit -->
<div class="modal fade" id="editLimitModal" tabindex="-1" aria-labelledby="editLimitModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="editLimitForm" class="modal-content">
      <input type="hidden" name="id" id="edit-id">

      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title" id="editLimitModalLabel">Edit Limit Akun VPN</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="mb-3">
          <label for="edit-user" class="form-label">Username</label>
          <input type="text" id="edit-user" class="form-control text-nowrap" disabled>
        </div>

        <div class="mb-3">
          <label for="edit-limit" class="form-label">Limit Akun</label>
          <input type="number" name="limit" id="edit-limit" class="form-control" required>
        </div>

        <div class="mb-3">
          <label for="edit-used" class="form-label">Akun Digunakan</label>
          <input type="number" id="edit-used" class="form-control text-nowrap" disabled>
        </div>
      </div>

      <div class="modal-footer">
        <button type="submit" class="btn btn-warning"><i class="bi bi-save me-1"></i> Simpan</button>
      </div>
    </form>
  </div>
</div>

<!-- Scripts -->
<script>
  $(document).ready(function () {
    $('#limitTable').DataTable({
      responsive: true,
      lengthChange: true,
      paging: true,
      info: true,
      ordering: true,
      searching: true,
      language: {
        search: "üîç Cari:",
        lengthMenu: "Tampilkan _MENU_ data per halaman",
        info: "Menampilkan _START_ sampai _END_ dari total _TOTAL_ data",
        paginate: {
          first: "Awal",
          last: "Akhir",
          next: "‚Ä∫",
          previous: "‚Äπ"
        },
        emptyTable: "Tidak ada data tersedia"
      },
      dom: `
        <'row mb-3'
          <'col-md-6 d-flex align-items-center'l>
          <'col-md-6'f>
        >
        <'table-responsive't>
        <'row mt-3'
          <'col-md-6'i>
          <'col-md-6'p>
        >`
    });

    // Modal handler
    document.querySelectorAll(".btn-edit").forEach(button => {
      button.addEventListener("click", function () {
        document.getElementById("edit-id").value = this.dataset.id;
        document.getElementById("edit-user").value = this.dataset.user;
        document.getElementById("edit-limit").value = this.dataset.limit;
        document.getElementById("edit-used").value = this.dataset.used;

        new bootstrap.Modal(document.getElementById("editLimitModal")).show();
      });
    });

    // Submit Form
    document.getElementById("editLimitForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const id = document.getElementById("edit-id").value;
      const limit = parseInt(document.getElementById("edit-limit").value);
      const used = parseInt(document.getElementById("edit-used").value);

      if (limit < used) {
        Swal.fire({
          icon: 'error',
          title: 'Limit Tidak Valid',
          text: 'Limit tidak boleh lebih kecil dari akun yang sudah digunakan.',
        });
        return;
      }

      const response = await fetch("/admin/update-limit-akun", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id, limit })
      });

      const result = await response.json();

      if (result.success) {
        document.getElementById(`limit-value-${id}`).textContent = limit;
        document.getElementById(`updated-at-${id}`).textContent = new Date().toLocaleString('id-ID');
        bootstrap.Modal.getInstance(document.getElementById("editLimitModal")).hide();
        Swal.fire({
          icon: 'success',
          title: 'Berhasil',
          text: result.message,
          timer: 2000,
          showConfirmButton: false
        });
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Gagal',
          text: result.message || "Gagal memperbarui limit.",
        });
      }
    });
  });
</script>
