<section class="content mt-3">
  <div class="container-fluid">

    <% if (flashData) { %>
      <div class="alert alert-<%= flashData.type %> alert-dismissible fade show" role="alert">
        <%= flashData.text %>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    <% } %>

    <div class="card shadow-sm">
      <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-person-check-fill me-2"></i> Data Limit Akun VPN</h5>
        <button class="btn btn-success btn-sm" id="btn-add-new"><i class="bi bi-plus-circle me-1"></i> Tambah Baru</button>
      </div>

      <div class="card-body">
          <table id="limitTable" class="table table-bordered table-hover table-striped text-nowrap align-middle w-100">
            <thead class="table-primary text-center">
              <tr>
                <th>ID</th>
                <th>User ID</th>
                <th>Username</th>
                <th>Limit</th>
                <th>Used</th>
                <th>Dibuat</th>
                <th>Diupdate</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody>
              <% if (limits && limits.length > 0) { %>
                <% limits.forEach(item => { %>
                  <tr id="row-<%= item.id %>">
                    <td><%= item.id %></td>
                    <td class="user-id"><%= item.user_id %></td>
                    <td class="username"><%= item.username %></td>
                    <td class="limit"><%= item.limit %></td>
                    <td class="used"><%= item.used %></td>
                    <td class="created"><%= new Date(item.created_at).toLocaleString('id-ID') %></td>
                    <td class="updated"><%= new Date(item.updated_at).toLocaleString('id-ID') %></td>
                    <td class="text-center">
                      <button class="btn btn-sm btn-info btn-detail"><i class="bi bi-eye"></i></button>
                      <button class="btn btn-sm btn-warning btn-edit"><i class="bi bi-pencil"></i></button>
                      <button class="btn btn-sm btn-danger btn-delete"><i class="bi bi-trash"></i></button>
                    </td>
                  </tr>
                <% }) %>
              <% } else { %>
                <tr><td colspan="8" class="text-center">Tidak ada data tersedia</td></tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>

  </div>
</section>

<!-- Modal Tambah/Edit -->
<div class="modal fade" id="limitModal" tabindex="-1" aria-labelledby="limitModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="limitForm" class="modal-content">
      <input type="hidden" id="limit-id">
      <input type="hidden" id="user-id">

      <div class="modal-header">
        <h5 class="modal-title" id="limitModalLabel">Tambah Limit Baru</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="mb-3">
          <label for="username" class="form-label">Pilih User</label>
          <select id="username" name="username" class="form-select" required>
            <option value="" disabled selected>Pilih user</option>
            <% if (allUsers && allUsers.length > 0) { %>
              <% allUsers.forEach(u => { %>
                <option value="<%= u.username %>" data-id="<%= u.id %>">
                  [ID: <%= u.id %>] <%= u.username %>
                </option>
              <% }) %>
            <% } else { %>
              <option value="" disabled>Tidak ada user tersedia</option>
            <% } %>
          </select>
        </div>

        <div class="mb-3">
          <label for="limit" class="form-label">Limit Akun</label>
          <input type="number" id="limit" name="limit" class="form-control" min="0" required>
        </div>
      </div>

      <div class="modal-footer">
        <button type="submit" class="btn btn-primary"><i class="bi bi-save me-1"></i> Simpan</button>
      </div>
    </form>
  </div>
</div>

<script>
$(document).ready(function () {
  // ‚úÖ Inisialisasi DataTable dengan konfigurasi yang rapi
  const table = $('#limitTable').DataTable({
    responsive: true,
    autoWidth: false,
    pageLength: 10,
    lengthMenu: [5, 10, 25, 50, 100],
    order: [[0, "desc"]],
    dom:
      "<'row mb-3'<'col-md-6 d-flex align-items-center'f><'col-md-6 text-end'l>>" +
      "<'table-responsive'tr>" +
      "<'row mt-3'<'col-md-6'i><'col-md-6 text-end'p>>",
    language: {
      search: "_INPUT_",
      searchPlaceholder: "üîç Cari data...",
      lengthMenu: "Tampilkan _MENU_ data",
      info: "Menampilkan _START_‚Äì_END_ dari _TOTAL_ data",
      paginate: {
        previous: "‚Äπ",
        next: "‚Ä∫"
      },
      emptyTable: "Tidak ada data tersedia"
    }
  });

  // Tambahkan styling agar search box-nya proporsional
  $('div.dataTables_filter input').addClass('form-control form-control-sm');
  $('div.dataTables_length select').addClass('form-select form-select-sm');

  // =====================
  // Tambah Baru
  // =====================
  $('#btn-add-new').on('click', function () {
    $('#limitForm')[0].reset();
    $('#limit-id').val('');
    $('#limitModalLabel').text('Tambah Limit Baru');
    $('#limitModal .modal-header')
      .removeClass('bg-warning text-dark')
      .addClass('bg-success text-white');

    // üî• Filter username yang sudah punya limit
    const existingUsernames = [];
    $('#limitTable tbody tr').each(function () {
      const username = $(this).find('.username').text().trim();
      if (username) existingUsernames.push(username);
    });

    $('#username option').each(function () {
      const username = $(this).val();
      $(this).prop('disabled', existingUsernames.includes(username));
    });

    new bootstrap.Modal('#limitModal').show();
  });

  // =====================
  // Isi user_id otomatis
  // =====================
  $('#username').on('change', function () {
    const userId = $(this).find(':selected').data('id');
    $('#user-id').val(userId);
  });

  // =====================
  // Edit Data
  // =====================
  $('#limitTable').on('click', '.btn-edit', function () {
    const row = $(this).closest('tr');
    const id = row.attr('id').replace('row-', '');
    const userId = row.find('.user-id').text();
    const username = row.find('.username').text();
    const limit = row.find('.limit').text();

    $('#limit-id').val(id);
    $('#user-id').val(userId);
    $('#username').val(username);
    $('#limit').val(limit);
    $('#limitModalLabel').text('Edit Limit Akun');
    $('#limitModal .modal-header')
      .removeClass('bg-success text-white')
      .addClass('bg-warning text-dark');
    new bootstrap.Modal('#limitModal').show();
  });

  // =====================
  // Simpan (Add/Edit)
  // =====================
  $('#limitForm').submit(async function (e) {
    e.preventDefault();

    const id = $('#limit-id').val();
    const user_id = $('#user-id').val();
    const username = $('#username').val();
    const limit = parseInt($('#limit').val());

    if (!user_id || !username) {
      Swal.fire('Error', 'User wajib dipilih.', 'error');
      return;
    }

    const url = id ? '/admin/vpn-server/update-limit-akun' : '/admin/vpn-server/add-limit-akun';
    const payload = id ? { id, user_id, username, limit } : { user_id, username, limit };

    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const result = await res.json();

    if (result.success) {
      const now = new Date().toLocaleString('id-ID');
      const modal = bootstrap.Modal.getInstance(document.getElementById('limitModal'));
      modal.hide();

      if (id) {
        const row = $(`#row-${id}`);
        row.find('.user-id').text(user_id);
        row.find('.username').text(username);
        row.find('.limit').text(limit);
        row.find('.updated').text(now);
        Swal.fire('Berhasil', 'Data berhasil diperbarui.', 'success');
      } else {
        const d = result.data;
        const newRow = table.row.add([
          d.id, d.user_id, d.username, d.limit, d.used,
          new Date(d.created_at).toLocaleString('id-ID'),
          new Date(d.updated_at).toLocaleString('id-ID'),
          `
            <button class="btn btn-sm btn-info btn-detail"><i class="bi bi-eye"></i></button>
            <button class="btn btn-sm btn-warning btn-edit"><i class="bi bi-pencil"></i></button>
            <button class="btn btn-sm btn-danger btn-delete"><i class="bi bi-trash"></i></button>
          `
        ]).draw(false).node();
        $(newRow).attr('id', `row-${d.id}`);
        $(newRow).find('td:eq(1)').addClass('user-id');
        $(newRow).find('td:eq(2)').addClass('username');
        $(newRow).find('td:eq(3)').addClass('limit');
        $(newRow).find('td:eq(4)').addClass('used');
        $(newRow).find('td:eq(5)').addClass('created');
        $(newRow).find('td:eq(6)').addClass('updated');
        Swal.fire('Berhasil', 'Data baru berhasil ditambahkan.', 'success');
      }
    } else {
      Swal.fire('Gagal', result.message || 'Terjadi kesalahan.', 'error');
    }
  });

  // =====================
  // Hapus Data
  // =====================
  $('#limitTable').on('click', '.btn-delete', async function () {
    const row = $(this).closest('tr');
    const id = row.attr('id').replace('row-', '');

    Swal.fire({
      title: 'Yakin ingin menghapus?',
      text: 'Data akan hilang permanen!',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonText: 'Batal',
      confirmButtonText: 'Hapus'
    }).then(async (resSwal) => {
      if (resSwal.isConfirmed) {
        const res = await fetch(`/admin/vpn-server/delete-limit-akun/${id}`, { method: 'DELETE' });
        const result = await res.json();
        if (result.success) {
          table.row(row).remove().draw(false);
          Swal.fire('Terhapus!', 'Data berhasil dihapus.', 'success');
        } else {
          Swal.fire('Gagal', result.message || 'Gagal menghapus data.', 'error');
        }
      }
    });
  });

  // =====================
  // Detail
  // =====================
  $('#limitTable').on('click', '.btn-detail', function () {
    const row = $(this).closest('tr');
    Swal.fire({
      title: `Detail Akun: ${row.find('.username').text()}`,
      html: `
        <p><strong>User ID:</strong> ${row.find('.user-id').text()}</p>
        <p><strong>Limit:</strong> ${row.find('.limit').text()}</p>
        <p><strong>Used:</strong> ${row.find('.used').text()}</p>
      `,
      icon: 'info'
    });
  });
});
</script>

