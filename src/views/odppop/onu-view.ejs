<!-- Header -->
<div class="content-header mt-2">
  <div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center">
      <h3 class="mb-0"><%= title %> <%= odp.name %></h3>
    </div>
  </div>
</div>

<!-- Content -->
<div class="content">
  <div class="container-fluid">
    <% if (flashData) { %>
      <div class="alert alert-<%= flashData.type %> alert-dismissible fade show mt-2" role="alert">
        <%= flashData.text %>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    <% } %>

    <div class="card shadow-sm mt-3">
      <div class="card-header bg-primary text-white">
        <h5 class="card-title mb-0"><i class="bi bi-hdd-network me-1"></i> Data Onu</h5>
      </div>

      <div class="card-body">
        <div class="table-responsive">
          <table id="routerTable" class="table table-bordered table-hover align-middle text-nowrap">
            <thead class="table-info">
              <tr>
                <th>No</th>
                <th>Nama</th>
                <th>No Internet</th>
                <th>Optic</th>
                <th>Regis</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="routerBody">
              <% if (data.length > 0) { %>
                <% data.forEach((router, index) => { %>
                  <tr>
                    <td><%= index + 1 %></td>
                    <td><%= router.nama %></td>
                    <td><%= router.no_internet %></td>
                    <td>
                      <% if (router.optic_status === 'linkup') { %>
                        <span class="badge bg-success">linkup</span>
                      <% } else { %>
                        <span class="badge bg-warning text-dark"><%= router.optic_status %></span>
                      <% } %>
                    </td>
                    <td>
                      <% if (router.status === 'active') { %>
                        <span class="badge bg-success">Activated</span>
                      <% } else { %>
                        <span class="badge bg-secondary"><%= router.status %></span>
                      <% } %>
                    </td>
                    <td>
                      <button class="btn btn-sm btn-warning btn-edit"
                        data-id="<%= router.id %>"
                        data-nama="<%= router.nama %>"
                        data-no_internet="<%= router.no_internet %>"
                        data-lokasi="<%= router.lokasi || '' %>"
                        data-odp="<%= router.id_odp || '' %>">
                        <i class="bi bi-pencil-square"></i>
                      </button>
                      <button class="btn btn-sm btn-danger btn-delete" data-id="<%= router.id %>" data-name="<%= router.nama %>"><i class="bi bi-trash"></i></button>
                    </td>
                  </tr>
                <% }); %>
              <% } else { %>
                <tr>
                  <td colspan="6" class="text-center text-muted">Tidak ada data ONU</td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Modal Edit ONU -->
<div class="modal fade" id="editOnuModal" tabindex="-1" aria-labelledby="editOnuModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content shadow">
      <form id="formEditOnu" method="POST">
        <div class="modal-header bg-warning text-white">
          <h5 class="modal-title" id="editOnuModalLabel">
            <i class="bi bi-pencil-square me-2"></i> Edit Data ONU
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Tutup"></button>
        </div>

        <div class="modal-body row g-3">
          <div class="col-md-12">
            <label for="editLocation" class="form-label">
              Odp Port
            </label>
            <select name="odp_id" id="odpEditList" class="form-control">
              <option value="">---PILIH ODP---</option>
              <% if (odpData.length > 0) { %>
                <% odpData.forEach(odp => { %>
                  <option value="<%= odp.id %>"><%= odp.name %> (Port: <%= odp.used %>/<%= odp.capacity %>)</option>
                <% }) %>
              <% } %>
            </select>
          </div>
          
          <div class="col-md-6">
            <label for="editHostname" class="form-label">Hostname</label>
            <input type="text" class="form-control" id="editHostname" name="hostname" required>
          </div>

          <div class="col-md-6">
            <label for="editNoInternet" class="form-label">No Internet</label>
            <input type="text" class="form-control" id="editNoInternet" name="no_internet" required>
          </div>

          <div class="col-md-12">
            <label for="editLocation" class="form-label">Lokasi</label>
            <input type="text" class="form-control" id="editLocation" name="location" required>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="submit" class="btn btn-warning text-white">
            <i class="bi bi-save"></i> Simpan Perubahan
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
$(document).ready(function () {
  // ====================================
  // 2. HANDLER TOMBOL EDIT
  // ====================================
  $(document).on("click", ".btn-edit", function () {
    const id = $(this).data("id");
    const nama = $(this).data("nama");
    const noInternet = $(this).data("no_internet");
    const lokasi = $(this).data("lokasi");
    const odpId  = $(this).data("odp");

    $("#editHostname").val(nama);
    $("#editNoInternet").val(noInternet);
    $("#editLocation").val(lokasi);
    $("#odpEditList").val(odpId);
    $("#formEditOnu").attr("action", `/admin/edit-onu/${id}`);

    $("#editOnuModal").modal("show");
  });

  // ====================================
  // 3. SUBMIT FORM EDIT
  // ====================================
  $(document).on("submit", "#formEditOnu", function (e) {
    e.preventDefault();
    const form = $(this);
    const actionUrl = form.attr("action");
    const data = form.serialize();
  
    $.ajax({
      url: actionUrl,
      type: "POST",
      data: data,
      dataType: "json",
      success: function (res) {
        console.log(res);
  
        Swal.fire({
          icon: "success",
          title: "Berhasil",
          text: "Data ONU berhasil diperbarui",
          timer: 2000,
          showConfirmButton: false
        }).then(() => {
          // update row DataTable / reload
          location.reload();
        });
      },
      error: function (xhr, status, err) {
        Swal.fire({
          icon: "error",
          title: "Gagal",
          text: "Terjadi kesalahan saat menyimpan data."
        });
        console.error("Edit ONU error:", err, xhr.responseText);
      }
    });
  });


  // ====================================
  // 4. HANDLER TOMBOL DELETE
  // ====================================
  $(document).on("click", ".btn-delete", function () {
    const id = $(this).data("id");
    const name = $(this).data("name");

    Swal.fire({
      title: `Hapus ONU '${name}'?`,
      text: "Tindakan ini tidak dapat dibatalkan!",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Ya, Hapus",
      cancelButtonText: "Batal",
      confirmButtonColor: "#d33",
      cancelButtonColor: "#3085d6"
    }).then((result) => {
      if (result.isConfirmed) {
        $.ajax({
          url: `/admin/onu/delete/${id}`,
          type: "DELETE",
          success: function () {
            Swal.fire({
              icon: "success",
              title: "Berhasil",
              text: `Data ONU '${name}' berhasil dihapus`,
              timer: 2000,
              showConfirmButton: false
            }).then(() => location.reload());
          },
          error: function () {
            Swal.fire({
              icon: "error",
              title: "Gagal",
              text: "Terjadi kesalahan saat menghapus data."
            });
          }
        });
      }
    });
  });
});
</script>