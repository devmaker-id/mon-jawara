<section class="content mt-3">
  <div class="container-fluid">

    <% if (flashData) { %>
      <div class="alert alert-<%= flashData.type %>" role="alert">
        <%= flashData.text %>
      </div>
    <% } %>

    <div class="card shadow-sm">
      <form method="POST" action="/kasir/tambah-penjualan">

        <!-- Header -->
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-book"></i> Tambah Penjualan</h5>
        </div>

        <!-- Body -->
        <div class="card-body">

          <!-- Tanggal -->
          <div class="mb-3">
            <label class="form-label">Tanggal</label>
            <input type="text" class="form-control" value="<%= new Date().toLocaleString('id-ID') %>" readonly>
            <small class="text-muted">Tanggal transaksi tercatat otomatis oleh sistem</small>
          </div>

          <!-- Seller -->
          <div class="mb-3">
            <label class="form-label">Seller</label>
            <select name="seller_id" id="seller_id" class="form-select select2" required>
              <option value="">-- Pilih Seller --</option>
              <% if (sellers && sellers.length > 0) { %>
                <% sellers.forEach(s => { %>
                  <option value="<%= s.id %>"><%= s.name %> - <%= s.alamat %></option>
                <% }) %>
              <% } else { %>
                <option value="">Tidak ada seller</option>
              <% } %>
            </select>
          </div>

          <!-- Produk Terjual -->
          <div class="mb-3">
            <label class="form-label">Produk Terjual</label>
            <div class="table-responsive">
              <table class="table table-bordered table-hover" id="produkTable">
                <thead class="table-light">
                  <tr>
                    <th>Produk</th>
                    <th>Harga</th>
                    <th>Qty</th>
                    <th>Subtotal</th>
                    <th>Aksi</th>
                  </tr>
                </thead>
                <tbody id="produkBody"></tbody>
              </table>
            </div>
            <button type="button" class="btn btn-primary btn-sm" id="addProduk">
              <i class="bi bi-plus"></i> Tambah Produk
            </button>
          </div>

          <!-- Total -->
          <div class="mt-3 text-end">
            <h4>Total: Rp <span id="grandTotal">0</span></h4>
            <input type="hidden" name="grand_total" id="grand_total">
          </div>

          <!-- Metode Pembayaran -->
          <div class="mb-3">
            <label class="form-label">Metode Pembayaran</label>
            <select id="metode" name="metode" class="form-select" required>
              <option value="Cash">Cash</option>
              <option value="Transfer">Transfer</option>
              <option value="QRIS">QRIS</option>
            </select>
          </div>

          <!-- Detail Metode -->
          <div id="metodeDetail"></div>

          <!-- Status -->
          <div class="mb-3">
            <label class="form-label">Status</label>
            <select name="status" class="form-select" required>
              <option value="lunas">Lunas</option>
              <option value="belum">Belum</option>
            </select>
          </div>

          <!-- Keterangan -->
          <div class="mb-3">
            <label class="form-label">Keterangan</label>
            <input type="text" class="form-control" name="keterangan">
          </div>

        </div>

        <!-- Footer -->
        <div class="card-footer text-end">
          <button class="btn btn-success"><i class="bi bi-save"></i> Simpan Transaksi</button>
        </div>

      </form>
    </div>
  </div>
</section>

<script>
  $(document).ready(function () {
  // SELECT2 untuk seller
  $('#seller_id').select2({ placeholder: 'üîç Cari Seller...', allowClear: true, width: '100%' });

  let produkIndex = 0;

  function updateGrandTotal() {
    let total = 0;
    $('.subtotal').each(function () { total += parseFloat($(this).val()) || 0; });
    $('#grandTotal').text(total.toLocaleString('id-ID'));
    $('#grand_total').val(total);
  }

  // Tambah produk
  $('#addProduk').click(function () {
    produkIndex++;
    const allProducts = <%- JSON.stringify(products) %>;
    const sellerProducts = <%- JSON.stringify(sellerProducts[0]) %>;
    console.log(allProducts);
    console.log(sellerProducts);

    const sellerId = $('#seller_id').val() || "0";

    const filtered = allProducts.map(p => {
      const sp = sellerProducts.find(sp => sp.product_id === p.product_id && sp.seller_id == sellerId);
      return {
        product_id: p.product_id,
        nama: p.nama,
        harga: sp ? sp.harga : p.harga,
        isSeller: !!sp
      };
    });

    let optionsHtml = '<option value="">-- Pilih Produk --</option>';
    filtered.forEach(p => optionsHtml += `<option value="${p.product_id}" data-harga="${p.harga}">${p.nama} ${p.isSeller ? '(Seller)' : ''}</option>`);

    const row = `
<tr>
  <td data-label="Produk"><select name="produk_id[]" class="form-select select2 produkSelect" required>${optionsHtml}</select></td>
  <td data-label="Harga"><input type="number" class="form-control harga" name="harga[]" value="0" readonly></td>
  <td data-label="Qty"><input type="number" class="form-control qty" name="qty[]" min="1" value="1" required></td>
  <td data-label="Subtotal"><input type="number" class="form-control subtotal" name="subtotal[]" value="0" readonly></td>
  <td data-label="Aksi" class="text-center"><button type="button" class="btn btn-danger btnRemove w-100"><i class="bi bi-trash"></i> Hapus</button></td>
</tr>`;
    $('#produkBody').append(row);
    $('.produkSelect').select2({ width: '100%' });
  });

  // Hapus produk
  $(document).on('click', '.btnRemove', function () { $(this).closest('tr').remove(); updateGrandTotal(); });

  // Pilih produk ‚Üí update harga & subtotal
  $(document).on('change', '.produkSelect', function () {
    const harga = $(this).find(':selected').data('harga') || 0;
    const row = $(this).closest('tr');
    row.find('.harga').val(harga);
    row.find('.qty').val(1);
    row.find('.subtotal').val(harga);
    updateGrandTotal();
  });

  // Ubah qty ‚Üí update subtotal
  $(document).on('input', '.qty', function () {
    const row = $(this).closest('tr');
    const harga = parseFloat(row.find('.harga').val()) || 0;
    row.find('.subtotal').val(harga * (parseInt($(this).val()) || 0));
    updateGrandTotal();
  });

  // Metode Pembayaran
  $('#metode').on('change', function () {
    const metode = $(this).val();
    const container = $('#metodeDetail');
    container.empty();
    if (metode === 'Transfer') {
      container.html(`<div class="row"><div class="col-md-6 mb-2">
        <label class="form-label">Nama Bank</label>
        <input class="form-control mb-2" name="bank_name" value="BANK CENTRAL ASIA (BCA)" readonly>
        <input class="form-control mb-2" name="no_rek" value="542-114-1232" readonly>
        <input class="form-control" name="rek_name" value="MUNJI SETIAWAN" readonly>
      </div></div>`);
    } else if (metode === 'QRIS') {
      container.html(`<div class="mb-2 text-center">
        <label class="form-label">QRIS BIBITNET</label>
        <div class="border rounded p-3 bg-light">
          <img src="/assets/qris.png" alt="QRIS" style="max-width:150px">
          <p class="small text-muted mt-2 mb-0">Scan QR di atas untuk pembayaran, pastikan nama toko BIBITNET</p>
        </div>
      </div>`);
    }
  });

  // Reset saat seller ganti
  $('#seller_id').on('change', function () {
    $('#produkBody').empty();
    updateGrandTotal();
  });
});

</script>