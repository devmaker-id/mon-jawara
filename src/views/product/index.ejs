<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">

<div class="container-fluid mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>ðŸ“¦ Daftar Produk</h3>
    <a href="/admin/product/add-new" class="btn btn-primary">
      <i class="bi bi-plus-lg"></i> Tambah Produk
    </a>
  </div>

  <!-- Filter -->
  <div class="row mb-3">
    <div class="col-md-6 mb-2">
      <input type="text" id="filterNama" class="form-control" placeholder="Cari nama produk...">
    </div>
    <div class="col-md-3 mb-2">
      <select id="filterStatus" class="form-select">
        <option value="">Semua Status</option>
        <option value="active">Aktif</option>
        <option value="inactive">Nonaktif</option>
      </select>
    </div>
    <div class="col-md-3 mb-2">
      <button id="applyFilter" class="btn btn-success w-100">Terapkan Filter</button>
    </div>
  </div>

  <!-- Tabel Produk -->
  <table id="produkTable" class="table table-bordered table-hover table-striped shadow-sm nowrap" style="width:100%">
    <thead class="table-dark text-center">
      <tr>
        <th>#</th>
        <th>Nama</th>
        <th>Harga</th>
        <th>Stok</th>
        <th>Status</th>
        <th>Dibuat</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody>
      <% products.forEach((p, i) => { %>
        <tr>
          <td class="text-center"><%= i + 1 %></td>
          <td><%= p.nama %></td>
          <td>Rp <%= p.harga.toLocaleString('id-ID') %></td>
          <td>
            <% if (p.stok <= 5) { %>
              <span class="badge bg-danger"><%= p.stok %> (Habis)</span>
            <% } else if (p.stok <= 20) { %>
              <span class="badge bg-warning text-dark"><%= p.stok %> (Menipis)</span>
            <% } else { %>
              <span class="badge bg-success"><%= p.stok %></span>
            <% } %>
          </td>
          <td>
            <span class="badge bg-<%= p.status === 'active' ? 'primary' : 'secondary' %>">
              <%= p.status === 'active' ? 'Aktif' : 'Nonaktif' %>
            </span>
          </td>
          <td><%= new Date(p.created_at).toLocaleDateString('id-ID') %></td>
          <td class="text-center">
            <a href="/admin/product/edit/<%= p.product_id %>" class="btn btn-sm btn-outline-warning">
              <i class="bi bi-pencil-square"></i>
            </a>
            <button 
              class="btn btn-sm btn-outline-danger btn-hapus" 
              data-id="<%= p.product_id %>"
              data-nama="<%= p.nama %>">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
      <% }) %>
    </tbody>
  </table>
</div>

<!-- Modal Konfirmasi Hapus -->
<div class="modal fade" id="confirmHapusModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Hapus Produk</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <p>Yakin ingin menghapus <strong id="hapusNama"></strong>?</p>
        <a id="hapusLink" href="#" class="btn btn-danger w-100">Ya, Hapus</a>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>

<script>
$(document).ready(function() {
  const table = $('#produkTable').DataTable({
    responsive: true,
    order: [[1, 'asc']],
    language: {
      search: "Cari:",
      lengthMenu: "Tampilkan _MENU_ data",
      zeroRecords: "Tidak ada data ditemukan",
      info: "Menampilkan _START_ - _END_ dari _TOTAL_ produk",
      infoEmpty: "Tidak ada data",
      paginate: {
        previous: "Sebelumnya",
        next: "Berikutnya"
      }
    }
  });

  // Filter custom
  $.fn.dataTable.ext.search.push(function(settings, data) {
    const namaFilter = $('#filterNama').val().toLowerCase();
    const statusFilter = $('#filterStatus').val();
    const namaProduk = data[1].toLowerCase();
    const statusProduk = data[4].toLowerCase();

    if (namaFilter && !namaProduk.includes(namaFilter)) return false;
    if (statusFilter && statusProduk !== statusFilter) return false;
    return true;
  });

  $('#applyFilter').on('click', () => table.draw());

  // Tombol hapus
  $('#produkTable').on('click', '.btn-hapus', function() {
    const id = $(this).data('id');
    const nama = $(this).data('nama');
    $('#hapusNama').text(nama);
    $('#hapusLink').attr('href', `/produk/hapus/${id}`);
    $('#confirmHapusModal').modal('show');
  });
});
</script>
