<div class="app-content-header">
  <div class="container-fluid">
    <div class="d-flex align-items-center justify-content-between">
      <div>
        <h3 class="mb-0"><i class="bi bi-diagram-3-fill me-2"></i><%= title %> </h3>
        <small class="text-muted">Manajemen profile group hotspot dan pppoe </small>
      </div>
      <div class="dropdown">
        <button class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
          <i class="bi bi-plus-circle me-1"></i> Aksi
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#modalAddGroup">
            <i class="bi bi-folder-plus me-1"></i> Tambah Group Profile
          </a></li>
          <li><a class="dropdown-item" href="#">
            <i class="bi bi-upload me-1"></i> Export Group ke Mikrotik
          </a></li>
          <li><a class="dropdown-item text-danger" href="#">
            <i class="bi bi-trash me-1"></i> Hapus Yang Dipilih
          </a></li>
        </ul>
      </div>
    </div>
  </div>
</div>

<section class="content mt-2">
  <div class="container-fluid">

    <!-- Tabel dummy Group Profile -->
    <div class="card shadow">
      <div class="card-body table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-dark">
            <tr>
              <th scope="col"><input type="checkbox" /></th>
              <th class="text-nowrap">Nama Group</th>
              <th>Jenis</th>
              <th class="text-nowrap">Type Module</th>
              <th class="text-nowrap">Ip local</th>
              <th class="text-nowrap">Start Ip</th>
              <th class="text-nowrap">End Ip</th>
              <th class="text-nowrap">Dns</th>
              <th>Owner</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody>
            <% if (module && module.length > 0) { module.forEach(group => { %>
              <tr>
                <td><input type="checkbox" value="<%= group.id %>" /></td>
                <td class="text-nowrap"><%= group.name %></td>
                <td><span class="badge bg-<%= group.service_type === 'HOTSPOT' ? 'info' : 'success' %>"><%= group.service_type %></span></td>
                <td class="text-nowrap"><%= group.module_ip %></td>
                <td><%= group.local_ip ? group.local_ip : "-" %></td>
                <td><%= group.start_ip ? group.start_ip : "-" %></td>
                <td><%= group.end_ip ? group.end_ip : "-" %></td>
                <td><%= group.dns %></td>
                <td><%= group.owner_name %></td>
                <td class="text-nowrap">
                  <button class="btn btn-sm btn-warning">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn btn-sm btn-danger">
                    <i class="bi bi-trash"></i>
                  </button>
                </td>
              </tr>
            <% }) } else {%>
              <tr>
                <td colspan="7" class="text-center text-muted"> Belum ada group yang di-assign </td>
              </tr><% } %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</section>

<div class="modal fade" id="modalAddGroup" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <form class="modal-content" id="formAddGroup">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="bi bi-folder-plus"></i> Tambah Group Profile</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="row g-3">
          <div class="col-12">
            <label>Nama Group</label>
            <input type="text" class="form-control" placeholder="Masukan nama group" name="groupname" required />
          </div>

          <div class="col-md-6">
            <label>Router Client</label>
            <select class="form-select" name="nasclient">
                <option value="">Router Nas ...</option>
              <% if (nas && nas.length > 0) { nas.forEach(n => { %>
                <option value="<%= n.id %>"><%= n.shortname %> - <%= n.nasname %></option>
              <% }) } else {%>
                <option value="">- Tidak Ada Nas -</option>
              <% } %>
            </select>
          </div>

          <div class="col-md-6">
            <label>Owner</label>
            <select class="form-select" name="owner">
                <option value="">Owner ...</option>
              <% owners.forEach(own => { %>
                <option value="<%= own.id %>"><%= own.username %> - <%= own.akun_type %></option>
              <% })%>
            </select>
          </div>
          
          <div class="col-md-6">
            <label>Service Type</label>
            <select class="form-select" name="grouptype">
              <option value="">Pilih type ...</option>
              <option value="hotspot">HOTSPOT</option>
              <option value="ppp">PPP</option>
            </select>
          </div>

          <!-- jika yang dipilih service type = hotspot matikan pilihan onlyhotspot -->
          <div class="col-md-6">
            <label>Module Ip Pool</label>
            <select class="form-select" name="poolmodule">
              <option value="onlyhotspot">GROUP ONLY (Hotspot Saja)</option>
              <option value="poolmikrotik">IP POOL MIKROTIK</option>
            </select>
          </div>
          <!-- jika dalam module ip pool memilih onlyhotspot hilangkan ini -->
          <div class="col-md-6 ip-pool-field">
            <label>Ip Lokal</label>
            <input type="text" class="form-control" placeholder="192.168.80.1" name="ipgw" />
          </div>
          <div class="col-md-6 ip-pool-field">
            <label>Ip Awal</label>
            <input type="text" class="form-control" placeholder="192.168.80.2" name="startip"/>
          </div>
          <div class="col-md-6 ip-pool-field">
            <label>Ip Terakhir</label>
            <input type="text" class="form-control" placeholder="192.168.80.254" name="endip"/>
          </div>
          <!-- sampai ini -->

          <div class="col-md-6">
            <label>Dns</label>
            <input type="text" class="form-control" value="8.8.8.8,8.8.4.4" name="dns"/>
          </div>
        </div>
      </div>

      <div class="modal-footer bg-light">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-check-circle"></i> Simpan
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Batal
        </button>
      </div>
    </form>
  </div>
</div>

<script>
$(document).ready(function () {

  const ipPoolField = $('.ip-pool-field');
  const serviceType = $('select[name="grouptype"]');
  const poolModule  = $('select[name="poolmodule"]');

  // default
  ipPoolField.hide();

  // SERVICE TYPE CHANGE
  serviceType.on('change', function () {
    const val = $(this).val();

    if (val === 'ppp') {
      // PPP TIDAK BOLEH onlyhotspot
      poolModule.val('poolmikrotik');
      poolModule.find('option[value="onlyhotspot"]').prop('disabled', true);
      ipPoolField.slideDown();
    } 
    else if (val === 'hotspot') {
      // HOTSPOT BOLEH KEDUANYA
      poolModule.find('option').prop('disabled', false);

      if (poolModule.val() === 'onlyhotspot') {
        ipPoolField.hide();
      } else {
        ipPoolField.show();
      }
    } 
    else {
      poolModule.find('option').prop('disabled', false);
      ipPoolField.hide();
    }
  });

  // POOL MODULE CHANGE
  poolModule.on('change', function () {
    if ($(this).val() === 'poolmikrotik') {
      ipPoolField.slideDown();
    } else {
      ipPoolField.slideUp();
    }
  });

  // SUBMIT FORM
  $('#formAddGroup').on('submit', function (e) {
    e.preventDefault();

    // VALIDASI
    if (!serviceType.val()) {
      Swal.fire('Oops!', 'Service type wajib dipilih', 'warning');
      return;
    }

    if (serviceType.val() === 'ppp' && poolModule.val() === 'onlyhotspot') {
      Swal.fire('Tidak valid!', 'PPP tidak boleh menggunakan module onlyhotspot', 'error');
      return;
    }

    if (poolModule.val() === 'poolmikrotik') {
      if (
        !$('input[name="ipgw"]').val() ||
        !$('input[name="startip"]').val() ||
        !$('input[name="endip"]').val()
      ) {
        Swal.fire('Oops!', 'IP Pool wajib diisi', 'warning');
        return;
      }
    }

    $.ajax({
      url: '/admin/profile/group/add',
      type: 'POST',
      data: $(this).serialize(),
      beforeSend() {
        Swal.fire({
          title: 'Menyimpan...',
          allowOutsideClick: false,
          didOpen: () => Swal.showLoading()
        });
      },
      success(res) {
        console.log(res);
        Swal.fire('Berhasil', res.message || 'Data tersimpan', 'success')
          .then(() => {
            $('#modalAddGroup').modal('hide');
            $('#formAddGroup')[0].reset();
            ipPoolField.hide();
          });
      },
      error(xhr) {
        Swal.fire(
          'Gagal',
          xhr.responseJSON?.message || 'Server error',
          'error'
        );
      }
    });
  });

});
</script>