<!-- views/server-radius.ejs -->
<div class="app-content-header">
  <div class="container-fluid">
    <div class="d-flex align-items-center justify-content-between">
      <div>
        <h3 class="mb-0"><%= title %> </h3>
        <small class="text-muted"> Manajement server radius </small>
      </div>
      <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#modalTambah">
          <i class="bi bi-plus-circle"></i> Tambah Server
        </button>
    </div>
  </div>
</div>


<section class="content mt-2">
  <div class="container-fluid">

    <% if (flashData) { %>
      <div class="alert alert-<%= flashData.type %>" role="alert">
        <%= flashData.text %>
      </div>
    <% } %>

    <div class="card shadow">
      <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
        <h3 class="card-title mb-0">
          <i class="bi bi-router-fill"></i> Daftar Server RADIUS
        </h3>
      </div>

      <div class="card-body">
        <div class="row">
          <% if (radiusServers && radiusServers.length > 0) { %>

            <% radiusServers.forEach(server => { %>
              <div class="col-md-6 col-xl-4 mb-3">
                <div class="card border shadow-sm h-100">
                  <div class="card-body">
                    <h5 class="card-title d-flex justify-content-between align-items-center">
                      <span><i class="bi bi-router me-2 "></i><%= server.name %> </span>

                      <% if (server.status === 'enable') { %>
                        <span class="badge bg-success">Aktif</span>
                      <% } else { %>
                        <span class="badge bg-danger">Mati</span>
                      <% } %>
                    </h5> <br>

                    <p class="mb-1"><i class="bi bi-globe"></i> IP: <code><%= server.host %></code></p>
                    <p class="mb-1"><i class="bi bi-geo-alt"></i> Lokasi: <%= server.location || '-' %></p>
                    <p class="mb-1"><i class="bi bi-ubuntu"></i> OS: <%= server.os || '-' %></p>
                  </div>

                  <div class="card-footer d-flex justify-content-end gap-2 bg-light">
                    <button
                      class="btn btn-sm btn-warning btn-edit"
                      data-server='<%- JSON.stringify(server) %>'>
                      <i class="bi bi-pencil-square"></i> Edit
                    </button>

                    <button
                      class="btn btn-sm btn-danger btn-delete"
                      data-id="<%= server.id %>"
                      data-name="<%= server.name %>">
                      <i class="bi bi-trash"></i> Hapus
                    </button>
                  </div>
                </div>
              </div>
            <% }) %>

          <% } else { %>

            <!-- JIKA DATA KOSONG -->
            <div class="col-12">
              <div class="alert alert-info text-center">
                <i class="bi bi-info-circle"></i>
                Belum ada server RADIUS yang terdaftar.
                <br>
                <small>Klik tombol <strong>Tambah Server</strong> untuk menambahkan.</small>
              </div>
            </div>

          <% } %>
        </div>
      </div>
    </div>

  </div>
</section>

<!-- Modal tambah radius server -->
<div class="modal fade" id="modalTambah" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <form id="formTambahServer" class="modal-content needs-validation" novalidate>

      <!-- HEADER -->
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          <i class="bi bi-plus-circle"></i> Tambah Server RADIUS
        </h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <!-- BODY -->
      <div class="modal-body">
        <div class="container-fluid">

          <!-- INFO SERVER -->
          <h6 class="text-muted mb-2">Informasi Server</h6>
          <div class="row g-3 mb-3">
            <div class="col-12 col-md-6">
              <label class="form-label">Nama Server</label>
              <input type="text" class="form-control" name="name" required>
              <div class="invalid-feedback">
                Nama server wajib diisi
              </div>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">IP / Host</label>
              <input type="text" class="form-control" name="host" required>
              <div class="invalid-feedback">
                Ip / Host wajib diisi
              </div>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">Sistem Operasi</label>
              <input type="text" class="form-control" name="os" placeholder="Ubuntu / Debian / dll" required>
              <div class="invalid-feedback">
                System operasi wajib diisi
              </div>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">Lokasi</label>
              <input type="text" class="form-control" name="location" placeholder="DC Jakarta / Office" required>
              <div class="invalid-feedback">
                Lokasi server wajib diisi
              </div>
            </div>
          </div>

          <hr>

          <!-- SSH -->
          <h6 class="text-muted mb-2">Akses SSH</h6>
          <div class="row g-3 mb-3">
            <div class="col-12 col-md-4">
              <label class="form-label">Username SSH</label>
              <input type="text" class="form-control" name="username">
              <div class="invalid-feedback">
                Username ssh server wajib diisi
              </div>
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label">Password SSH</label>
              <input type="password" class="form-control" name="password">
              <div class="invalid-feedback">
                Password sshserver wajib diisi
              </div>
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label">Port SSH</label>
              <input type="number" class="form-control" name="port_ssh" value="22">
            </div>
          </div>

          <hr>

          <!-- RADIUS PORT -->
          <h6 class="text-muted mb-2">Port RADIUS</h6>
          <div class="row g-3">
            <div class="col-12 col-md-6">
              <label class="form-label">Port Authentication</label>
              <input type="number" class="form-control" name="port_auth" value="1812">
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">Port Accounting</label>
              <input type="number" class="form-control" name="port_acct" value="1813">
            </div>
          </div>

        </div>
      </div>

      <!-- FOOTER -->
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button class="btn btn-success">
          <i class="bi bi-save"></i> Simpan
        </button>
      </div>

    </form>
  </div>
</div>

<!-- Modal edit -->
<!-- Modal Edit Server RADIUS -->
<div class="modal fade" id="modalEdit" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <form id="formEditServer" class="modal-content needs-validation" novalidate>
      <input type="hidden" name="id" id="edit-id">
      <!-- HEADER -->
      <div class="modal-header bg-warning">
        <h5 class="modal-title">
          <i class="bi bi-pencil-square"></i> Edit Server RADIUS
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <!-- BODY -->
      <div class="modal-body">
        <div class="container-fluid">

          <!-- INFO SERVER -->
          <h6 class="text-muted mb-2">Informasi Server</h6>
          <div class="row g-3 mb-3">

            <div class="col-12 col-md-6">
              <label class="form-label">Nama Server</label>
              <input type="text" class="form-control" id="edit-name" name="name" required>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">IP / Host</label>
              <input type="text" class="form-control" id="edit-host" name="host" required>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">Sistem Operasi</label>
              <input type="text" class="form-control" id="edit-os" name="os" required>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">Lokasi</label>
              <input type="text" class="form-control" id="edit-location" name="location" required>
            </div>

          </div>

          <hr>

          <!-- SSH -->
          <h6 class="text-muted mb-2">Akses SSH</h6>
          <div class="row g-3 mb-3">

            <div class="col-12 col-md-4">
              <label class="form-label">Username SSH</label>
              <input type="text" class="form-control" id="edit-username" name="username">
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label">Password SSH</label>
              <input type="password" class="form-control" id="edit-password" name="password">
              <small class="text-muted">Kosongkan jika tidak diubah</small>
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label">Port SSH</label>
              <input type="number" class="form-control" id="edit-port_ssh" name="port_ssh">
            </div>

          </div>

          <hr>

          <!-- RADIUS -->
          <h6 class="text-muted mb-2">Port RADIUS</h6>
          <div class="row g-3">

            <div class="col-12 col-md-6">
              <label class="form-label">Port Authentication</label>
              <input type="number" class="form-control" id="edit-port_auth" name="port_auth">
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label">Port Accounting</label>
              <input type="number" class="form-control" id="edit-port_acct" name="port_acct">
            </div>

          </div>

        </div>
      </div>

      <!-- FOOTER -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="submit" class="btn btn-warning">
          <i class="bi bi-save"></i> Update
        </button>
      </div>

    </form>
  </div>
</div>

<!-- modal hapus -->
<div class="modal fade" id="modalHapus" tabindex="-1">
  <div class="modal-dialog modal-sm">
    <form action="/radius/delete" method="POST" class="modal-content">
      <input type="hidden" name="id" id="delete-id">

      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Hapus Server</h5>
      </div>

      <div class="modal-body text-center">
        Yakin hapus server <br>
        <strong id="delete-name"></strong> ?
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Batal</button>
        <button class="btn btn-danger btn-sm">Hapus</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Remote Terminal -->
<div class="modal fade" id="modalRemoteTerminal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title">
          <i class="bi bi-terminal-dash"></i> Terminal Server (SSH Shell)
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body bg-black text-white p-3" style="font-family: monospace;">
        <div id="terminalOutput" style="height: 300px; overflow-y: auto; white-space: pre-line;">
          Connected to server: debian@192.168.88.1
        </div>

        <div class="d-flex mt-3">
          <span class="me-2 text-success">$</span>
          <input type="text" id="terminalInput" class="form-control bg-black text-white border-0 p-0" autofocus autocomplete="off" style="font-family: monospace;" placeholder="Ketik perintah dan tekan Enter...">
        </div>
      </div>

      <div class="modal-footer bg-dark text-white">
        <span class="me-auto">Status: <strong id="sshStatus">Terhubung</strong></span>
        <button class="btn btn-danger" data-bs-dismiss="modal">Tutup</button>
      </div>
    </div>
  </div>
</div>

<script>
$(document).ready(function () {

  /* ==========================
   * TAMBAH SERVER (AJAX)
   * ========================== */
  $('#formTambahServer').on('submit', function (e) {
    e.preventDefault();

    if (!this.checkValidity()) {
      this.classList.add('was-validated');
      return;
    }

    $.ajax({
      url: '/admin/radius-server/store',
      type: 'POST',
      data: $(this).serialize(),
      dataType: 'json',

      beforeSend() {
        Swal.fire({
          title: 'Menyimpan...',
          text: 'Mohon tunggu',
          allowOutsideClick: false,
          didOpen: () => Swal.showLoading()
        });
      },

      success(res) {
        Swal.fire('Berhasil', res.message, 'success').then(() => {
          $('#modalTambah').modal('hide');
          $('#formTambahServer')[0].reset();
          location.reload();
        });
      },

      error(xhr) {
        Swal.fire(
          'Gagal',
          xhr.responseJSON?.message || 'Terjadi kesalahan',
          'error'
        );
      }
    });
  });

  /* ==========================
   * EDIT SERVER (AJAX)
   * ========================== */
  $('#modalTambah, #modalEdit').on('hidden.bs.modal', function () {
    const form = $(this).find('form')[0];
    if (form) {
      form.reset();
      form.classList.remove('was-validated');
    }
  });
  
  $('#formEditServer').on('submit', function (e) {
    e.preventDefault();

    if (!this.checkValidity()) {
      this.classList.add('was-validated');
      return;
    }

    $.ajax({
      url: '/admin/radius-server/update',
      type: 'POST',
      data: $(this).serialize(),
      dataType: 'json',

      beforeSend() {
        Swal.fire({
          title: 'Mengupdate...',
          text: 'Mohon tunggu',
          allowOutsideClick: false,
          didOpen: () => Swal.showLoading()
        });
      },

      success(res) {
        console.log(res);

        Swal.fire('Berhasil', res.message, 'success').then(() => {
          $('#modalEdit').modal('hide');
          location.reload();
        });
      },

      error(xhr) {
        Swal.fire(
          'Gagal',
          xhr.responseJSON?.message || 'Update gagal',
          'error'
        );
      }
    });
  });

  /* ==========================
   * OPEN MODAL EDIT
   * ========================== */
  $(document).on('click', '.btn-edit', function () {
    const server = JSON.parse(this.dataset.server);

    $('#edit-id').val(server.id);
    $('#edit-name').val(server.name);
    $('#edit-host').val(server.host);
    $('#edit-location').val(server.location || '');
    $('#edit-os').val(server.os || '');
    $('#edit-username').val(server.username || '');
    $('#edit-port_ssh').val(server.port_ssh || 22);
    $('#edit-port_auth').val(server.port_auth || 1812);
    $('#edit-port_acct').val(server.port_acct || 1813);
    $('#edit-password').val('');

    new bootstrap.Modal('#modalEdit').show();
  });

  /* ==========================
   * DELETE MODAL
   * ========================== */
  $(document).on('click', '.btn-delete', function () {
    $('#delete-id').val(this.dataset.id);
    $('#delete-name').text(this.dataset.name);

    new bootstrap.Modal('#modalHapus').show();
  });

  /* ==========================
   * TERMINAL DUMMY (SAFE)
   * ========================== */
  const terminalInput = document.getElementById('terminalInput');
  const terminalOutput = document.getElementById('terminalOutput');

  if (terminalInput && terminalOutput) {
    terminalInput.addEventListener('keydown', function (e) {
      if (e.key !== 'Enter') return;

      e.preventDefault();
      const cmd = this.value.trim();
      if (!cmd) return;

      terminalOutput.insertAdjacentHTML(
        'beforeend',
        `<div><span class="text-success">$</span> ${cmd}</div>
         <div>Output dari: ${cmd}\n(total dummy)</div>`
      );

      this.value = '';
      terminalOutput.scrollTop = terminalOutput.scrollHeight;
    });
  }

});
</script>