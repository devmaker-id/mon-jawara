<div class="app-content-header">
  <div class="container-fluid">
    <div class="d-flex align-items-center justify-content-between">
      <div>
        <h3 class="mb-0"><%= title %> </h3>
        <small class="text-muted"> Manajement Nas Client</small>
      </div>
      <button class="btn btn-primary text-nowrap" data-bs-toggle="modal" data-bs-target="#modalAddNasVpn">
        <i class="bi bi-shield-lock me-1"></i> Tambah NAS
      </button>
  </div>
</div>

<section class="content mt-3">
  <div class="container-fluid">

    <!-- Flash Message -->
    <% if (flashData) { %>
      <div class="alert alert-<%= flashData.type %> alert-dismissible fade show" role="alert">
        <%= flashData.text %>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    <% } %>

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5><i class="bi bi-hdd-rack me-2"></i> NAS Client</h5>
    </div>

    <!-- Tabel NAS Client -->
    <div class="card shadow-sm">
      <div class="card-body table-responsive">
        <table class="table table-bordered table-hover align-middle">
          <thead class="table-info">
            <tr>
              <th>ID</th>
              <th>Nama</th>
              <th>IP Address</th>
              <th>Deskripsi</th>
              <th>Status</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody>
            <% if (nasClients && nasClients.length > 0) { %>
            <% nasClients.forEach(nas => { %>
              <tr>
                <td><%= nas.id %></td>
                <td class="text-nowrap"><%= nas.shortname %></td>
                <td><%= nas.nasname %></td>
                <td><%= nas.description %></td>
                <td>
                  <% if (nas.status === 'online') { %>
                    <span class="badge bg-success">Online</span>
                  <% } else { %>
                    <span class="badge bg-secondary">Offline</span>
                  <% } %>
                </td>
                <td class="text-nowrap">
                  <button 
                    class="btn btn-sm btn-warning"
                    data-bs-toggle="modal"
                    data-bs-target="#editNasModal"
                    data-id="<%= nas.id %>"
                    data-shortname="<%= nas.shortname %>"
                    data-nasname="<%= nas.nasname %>"
                    data-type="<%= nas.type %>"
                    data-ports="<%= nas.ports %>"
                    data-secret="<%= nas.secret %>"
                    data-server="<%= nas.server %>"
                    data-community="<%= nas.community %>"
                    data-description="<%= nas.description %>">
                    <i class="bi bi-pen"></i>
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="hapusNas('<%= nas.id %>')">
                    <i class="bi bi-trash"></i>
                  </button>
                </td>
              </tr>
            <% }) %>
            <% } else { %>
              <tr>
                <td colspan="6" class="text-center">...Tidak Ada Nas...</td>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>

  </div>
</section>

<!-- Modal Edit NAS -->
<div class="modal fade" id="editNasModal" tabindex="-1" aria-labelledby="editNasLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title" id="editNasLabel"><i class="bi bi-pen me-1"></i> Edit NAS</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editNasForm">
          <input type="hidden" id="editNasId">

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Nama (shortname)</label>
              <input type="text" class="form-control" id="editNasShortname" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Mikrotik Client (NAS)</label>
              <select class="form-select" id="editNasNasname" required>
                <option value="">Loading Mikrotik...</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label">Tipe</label>
              <input type="text" class="form-control" id="editNasType" placeholder="other / cisco / mikrotik">
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Port</label>
              <input type="number" class="form-control" id="editNasPorts" placeholder="Contoh: 1812">
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Secret</label>
              <input type="text" class="form-control" id="editNasSecret" required>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Server</label>
              <input type="text" class="form-control" id="editNasServer" placeholder="Optional">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Community</label>
              <input type="text" class="form-control" id="editNasCommunity" placeholder="Optional">
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Deskripsi</label>
            <textarea class="form-control" id="editNasDescription" rows="2"></textarea>
          </div>

          <div class="text-end">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
            <button type="submit" class="btn btn-warning">Simpan Perubahan</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Tambah Nas -->
<div class="modal fade" id="modalAddNasVpn" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">

      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="bi bi-plus-circle me-2"></i> Tambah NAS baru
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <form id="formAddNasVpn">
        <div class="modal-body">

          <div class="mb-3">
            <label class="form-label">Nama NAS</label>
            <input type="text" name="nasname" class="form-control" placeholder="Masukan nama NAS" required>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Auth</label>
              <input type="text" name="p_auth" class="form-control"
                value="<%= radPort ? radPort.port_auth : '' %>" readonly>
            </div>

            <div class="col-md-6 mb-3">
              <label class="form-label">Acct</label>
              <input type="text" name="p_acct" class="form-control"
                value="<%= radPort ? radPort.port_acct : '' %>" readonly>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Mikrotik Client</label>
            <select name="mikrotik" class="form-select" required>
              <% if(mkclient && mkclient.length > 0) { %>
                <option value="">Pilih Mikrotik...</option>
                <% mkclient.forEach(mk => { %>
                  <option value="<%= mk.id %>"><%= mk.name %></option>
                <% }) %>
              <% } else { %>
                <option value="">Tidak ada Mikrotik</option>
              <% } %>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Deskripsi</label>
            <input type="text" name="deskripsi" class="form-control"
              value="Nas-Client" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Domain Isolir (Opsional)</label>
            <input type="text" name="domainisolir" class="form-control"
              placeholder="https://isolir.example.net">
          </div>

        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Batal
          </button>
          <button type="submit" class="btn btn-primary" id="btn-radius">
            <i class="bi bi-router me-1"></i> Buat Radius & Simpan
          </button>
        </div>
      </form>

    </div>
  </div>
</div>

<script>
$(function () {

  $('#formAddNasVpn').on('submit', function (e) {
    e.preventDefault();

    const data = {
      name: $('input[name="nasname"]').val(),
      pauth: $('input[name="p_auth"]').val(),
      pacct: $('input[name="p_acct"]').val(),
      mikrotik: $('select[name="mikrotik"]').val(),
      deskripsi: $('input[name="deskripsi"]').val(),
      domain: $('input[name="domainisolir"]').val()
    };

    console.log(data);

    if (!data.name || !data.pauth || !data.pacct || !data.mikrotik || !data.deskripsi) {
      Swal.fire('Error', 'Semua field wajib diisi.', 'error');
      return;
    }

    Swal.fire({
      title: 'Buat Radius?',
      text: 'Radius akan dibuat di Mikrotik via VPN',
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: 'Ya, Lanjutkan',
      cancelButtonText: 'Batal'
    }).then((result) => {

      if (result.isConfirmed) {
        $.ajax({
          url: '/admin/nas-client/buat-radius',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify(data),
          beforeSend: function () {
            Swal.fire({
              title: 'Memproses...',
              allowOutsideClick: false,
              didOpen: () => Swal.showLoading()
            });
            $('#btn-radius').prop('disabled', true);
          },
          success: function (res) {
            if (res.success) {
              Swal.fire({
                icon: 'success',
                title: 'Berhasil',
                text: res.message || 'Radius berhasil dibuat!'
              }).then(() => {
                $('#modalAddNasVpn').modal('hide');
                window.location.href = '/admin/nas-client';
              });
            } else {
              Swal.fire({
                icon: 'info',
                title: 'Info',
                text: res.message || 'Gagal prosess'
              }).then(() => {
                $('#modalAddNasVpn').modal('hide');
                window.location.href = '/admin/nas-client';
              });
            }
          },
          error: function (xhr) {
            Swal.fire(
              'Gagal',
              xhr.responseJSON?.message || 'Terjadi kesalahan',
              'error'
            );
            $('#btn-radius').prop('disabled', false);
          }
        });
      }

    });
  });

});
</script>

<script>
  // Ketika tombol edit diklik â†’ isi form di modal
  $('#editNasModal').on('show.bs.modal', async function (event) {
  const button = $(event.relatedTarget);
  const nasId = button.data('id');
  const nasnameOld = button.data('nasname');

  $('#editNasId').val(nasId);
  $('#editNasShortname').val(button.data('shortname'));
  $('#editNasType').val(button.data('type'));
  $('#editNasPorts').val(button.data('ports'));
  $('#editNasSecret').val(button.data('secret'));
  $('#editNasServer').val(button.data('server'));
  $('#editNasCommunity').val(button.data('community'));
  $('#editNasDescription').val(button.data('description'));

  const $nasSelect = $('#editNasNasname');
  $nasSelect.html('<option value="">Loading Mikrotik...</option>');

  try {
    const res = await fetch(`/admin/mikrotik-client/byhost?nasId=${nasId}`);
    const data = await res.json();

    if (data.success && data.mikrotik && data.mikrotik.length > 0) {
      $nasSelect.empty();
      $nasSelect.append('<option value="">Pilih Mikrotik...</option>');

      data.mikrotik.forEach(mk => {
        const selected = mk.host === nasnameOld ? 'selected' : '';
        $nasSelect.append(`
          <option value="${mk.host}" ${selected}>
            ${mk.name} - ${mk.host}
          </option>
        `);
      });
    } else {
      $nasSelect.html('<option value="">Tidak ada Mikrotik tersedia</option>');
    }

  } catch (err) {
    console.error(err);
    $nasSelect.html('<option value="">Gagal memuat Mikrotik</option>');
  }
});

  // Submit form edit NAS
  $('#editNasForm').on('submit', async function (e) {
    e.preventDefault();

    const id = $('#editNasId').val();
    const payload = {
      shortname: $('#editNasShortname').val(),
      nasname: $('#editNasNasname').val(), // dari select
      type: $('#editNasType').val(),
      ports: $('#editNasPorts').val() || null,
      secret: $('#editNasSecret').val(),
      server: $('#editNasServer').val() || null,
      community: $('#editNasCommunity').val() || null,
      description: $('#editNasDescription').val()
    };


    try {
      const res = await fetch(`/admin/nas-client/change/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      console.log(data);

      if (data.success) {
        Swal.fire("Berhasil", data.message || "NAS berhasil diperbarui.", "success")
          .then(() => location.reload());
      } else {
        Swal.fire("Gagal", data.message || "Terjadi kesalahan saat memperbarui NAS.", "error");
      }
    } catch (err) {
      console.error(err);
      Swal.fire("Error", "Gagal menghubungi server.", "error");
    }
  });

  // Hapus NAS
  async function hapusNas(id) {
    const konfirmasi = await Swal.fire({
      title: "Yakin hapus?",
      text: "Data NAS akan dihapus permanen.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Ya, hapus!",
      cancelButtonText: "Batal"
    });

    if (!konfirmasi.isConfirmed) return;

    try {
      const res = await fetch(`/admin/nas-client/delete/${id}`, { method: 'DELETE' });
      const data = await res.json();

      if (data.success) {
        Swal.fire("Berhasil", data.message, "success").then(() => location.reload());
      } else {
        Swal.fire("Gagal", data.message || "Terjadi kesalahan saat menghapus.", "error");
      }
    } catch (err) {
      console.error(err);
      Swal.fire("Error", "Gagal menghubungi server.", "error");
    }
  }
</script>
